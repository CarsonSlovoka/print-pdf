<title>print-pdf</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

<body>
<main class="container">
  <h1>Print-pdf</h1>
  <form id="main">
    <label>filename<input name="filename" type="text" title="output filename" placeholder="output.pdf" required></label>
    <label>URL<input id="url" type="text" placeholder="http://127.0.0.1:8080/test.md?print-pdf" title="https://..." required></label>
    <!-- TODO: waitVisible 也許可以考慮設定成多個 -->
    <label>WaitVisible<input name="waitVisible" type="text" placeholder="body"></label>

    <fieldset>
      <legend>Printer</legend>
      <label>width<input name="width" type="number" step="0.1" min="1" placeholder="8.3" title="inches" value="8.3"></label>
      <label>height<input name="height" type="number" step="0.1" min="1" placeholder="11.7" title="inches" value="11.7"></label>
      <label>display header footer<input name="displayHeaderFooter" type="checkbox"></label>
      <label>printBackground<input name="printBackground" type="checkbox" checked></label>
      <fieldset>
        <legend>Margin</legend>
        <label>Top <input name="top" type="number" step="0.1" min="0" value="0"></label>
        <label>Bottom <input name="bottom" type="number" step="0.1" min="0" value="0"></label>
        <label>Left <input name="left" type="number" step="0.1" min="0" value="0"></label>
        <label>Right <input name="right" type="number" step="0.1" min="0" value="0"></label>
      </fieldset>
    </fieldset>

    <input type="submit"><input type="reset">
  </form>
  <pre></pre>
</main>
</body>

<script>
  function getFilename() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0')
    const day = String(now.getDate()).padStart(2, '0')
    const hours = String(now.getHours()).padStart(2, '0')
    const minutes = String(now.getMinutes()).padStart(2, '0')
    const seconds = String(now.getSeconds()).padStart(2, '0')

    return `${year}${month}${day}_${hours}_${minutes}_${seconds}`
  }

  const form = document.forms["main"]
  form.filename.value = getFilename() + ".pdf" // init
  form.onsubmit = async (e) => {
    e.preventDefault()
    const formData = new FormData()
    formData.set("url", form.url.value)
    formData.set("filename", form.filename.value)
    formData.set("waitVisible", form.waitVisible.value)

    formData.set("width", form.width.value)
    formData.set("height", form.height.value)
    formData.set("headerFooter", form.displayHeaderFooter.checked ? "1" : "0")
    formData.set("printBackground", form.printBackground.checked ? "1" : "0")
    formData.set("top", form.top.value)
    formData.set("bottom", form.bottom.value)
    formData.set("left", form.left.value)
    formData.set("right", form.right.value)

    const resp = await fetch("/download", {
      method: "post",
      body: formData,
    })
    if (!resp.ok) {
      alert(`${resp.statusText} (${resp.status}) | ${await resp.text()} `)
    } else {
      document.querySelector("pre").innerHTML = JSON.stringify(await resp.json(), null, 2)
    }
    return false
  }
</script>
